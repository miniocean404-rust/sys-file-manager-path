name: CI

env:
  CI: 1
  DEBUG: napi:*
  APP_NAME: sys-file-manager-path
  CARGO_TERM_COLOR: always
  MACOSX_DEPLOYMENT_TARGET: "10.13"
  CARGO_INCREMENTAL: '1'
  RUST_LOG: "off"

# 权限配置：允许写入内容和使用 ID token
permissions:
  contents: write
  id-token: write

on:
  push:
    branches:
      - master
    tags-ignore:
      - "**"
    paths-ignore:
      - "**/*.md"
      - LICENSE
      - "**/*.gitignore"
      - .editorconfig
      - docs/**
  pull_request: null
  merge_group: null

# 并发控制：同一工作流的不同运行会取消之前的运行
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # ============================================
  # Job 1: 代码检查（Lint）
  # ============================================
  lint:
    name: 代码检查
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: 设置 pnpm
        uses: pnpm/action-setup@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm

      - name: 安装 Rust 工具链
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: 安装依赖
        run: pnpm install

      - name: Cargo 格式化检查
        run: cargo fmt --all -- --check

      - name: Clippy 静态分析
        run: cargo clippy --all --all-targets -- -D warnings

  # ============================================
  # Job 2: 许可证检查 （未知）
  # ============================================
  cargo-deny:
    name: 检查依赖许可证
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, 'chore:') }}
    steps:
      - uses: actions/checkout@v6

      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable

      - name: 安装 cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny@0.14.15

      - name: 检查许可证
        run: cargo deny check

  # ============================================
  # Job 3: 多平台构建
  # ============================================
  build:
    name: 构建 ${{ matrix.settings.target }}
    runs-on: ${{ matrix.settings.host }}
    strategy:
      fail-fast: false
      matrix:
        settings:
          # macOS
          - host: macos-latest
            target: x86_64-apple-darwin
            build: pnpm build --target x86_64-apple-darwin

          - host: macos-latest
            target: aarch64-apple-darwin
            build: pnpm build --target aarch64-apple-darwin

          # Windows
          - host: windows-latest
            target: x86_64-pc-windows-msvc
            build: pnpm build --target x86_64-pc-windows-msvc

          - host: windows-latest
            target: i686-pc-windows-msvc
            build: pnpm build --target i686-pc-windows-msvc

          - host: windows-latest
            target: aarch64-pc-windows-msvc
            build: pnpm build --target aarch64-pc-windows-msvc

          # Linux
          - host: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            build: pnpm build --target x86_64-unknown-linux-gnu --use-napi-cross

          - host: ubuntu-latest
            target: x86_64-unknown-linux-musl
            build: pnpm build --target x86_64-unknown-linux-musl --use-napi-cross

          - host: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            build: pnpm build --target aarch64-unknown-linux-gnu --use-napi-cross

          - host: ubuntu-latest
            target: aarch64-unknown-linux-musl
            build: pnpm build --target aarch64-unknown-linux-musl --use-napi-cross

          - host: ubuntu-latest
            target: armv7-unknown-linux-gnueabihf
            build: pnpm build --target armv7-unknown-linux-gnueabihf --use-napi-cross

    steps:
      - uses: actions/checkout@v6

      - name: 设置 pnpm
        uses: pnpm/action-setup@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm

      - name: 安装 Rust 工具链
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.target }}

      - name: 缓存 Cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ~/.napi-rs
            .cargo-cache
            target/
          key: ${{ matrix.settings.target }}-cargo-${{ matrix.settings.host }}

      - name: 设置 Zig（musl 目标）
        if: ${{ contains(matrix.settings.target, 'musl') }}
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: 安装 cargo-zigbuild（musl 目标）
        if: ${{ contains(matrix.settings.target, 'musl') }}
        uses: taiki-e/install-action@v2
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          tool: cargo-zigbuild

      # 执行自定义工具链设置（如果配置了）
      - name: Setup toolchain
        run: ${{ matrix.settings.setup }}
        if: ${{ matrix.settings.setup }}
        shell: bash

      - name: 安装 pnpm 依赖
        run: pnpm install

      - name: 设置 Node.js x86（32 位 Windows）
        if: matrix.settings.target == 'i686-pc-windows-msvc'
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm
          architecture: x86

      - name: 构建
        run: ${{ matrix.settings.build }}
        shell: bash

      - name: 上传 Node.js 构建产物
        uses: actions/upload-artifact@v6
        with:
          name: bindings-${{ matrix.settings.target }}
          path: "*.node"
          if-no-files-found: error

      # 上传 WASM 构建产物（.wasm 文件）
      # - name: 上传 WASM 构建产物
      #   uses: actions/upload-artifact@v6
      #   if: matrix.settings.target == 'wasm32-wasip1-threads'
      #   with:
      #     name: bindings-${{ matrix.settings.target }}
      #     path: '*.wasm'
      #     if-no-files-found: error
  # ============================================
  # Job 4: macOS 和 Windows 测试
  # ============================================
  test-macOS-windows-binding:
    name: 测试 ${{ matrix.settings.target }} - node@${{ matrix.node }}
    needs:
      - build
    runs-on: ${{ matrix.settings.host }}
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: windows-latest
            target: x86_64-pc-windows-msvc
            architecture: x64
          - host: macos-latest
            target: x86_64-apple-darwin
            architecture: x64
          - host: macos-latest
            target: aarch64-apple-darwin
            architecture: arm64
        node:
          - "20"
          - "22"
    steps:
      - uses: actions/checkout@v6

      - name: 设置 pnpm
        uses: pnpm/action-setup@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm
          architecture: ${{ matrix.settings.architecture }}

      - name: 安装依赖
        run: pnpm install

      - name: 下载构建产物
        uses: actions/download-artifact@v7
        with:
          name: bindings-${{ matrix.settings.target }}
          path: .

      - name: 列出文件
        run: ls -R .
        shell: bash

      - name: 运行测试
        run: pnpm test

  # ============================================
  # Job 5: Linux 测试
  # ============================================
  test-linux-binding:
    name: 测试 ${{ matrix.target }} - node@${{ matrix.node }}
    needs: build
    runs-on: ${{ contains(matrix.target, 'aarch64') && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - x86_64-unknown-linux-musl
        node:
          - "20"
          - "22"
    steps:
      - uses: actions/checkout@v6

      - name: 设置 pnpm
        uses: pnpm/action-setup@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm

      - name: 生成 Docker 参数
        id: docker
        run: |
          node -e "
            if ('${{ matrix.target }}'.startsWith('aarch64')) {
              console.log('PLATFORM=linux/arm64')
            } else if ('${{ matrix.target }}'.startsWith('armv7')) {
              console.log('PLATFORM=linux/arm/v7')
            } else {
              console.log('PLATFORM=linux/amd64')
            }
          " >> $GITHUB_OUTPUT
          node -e "
            if ('${{ matrix.target }}'.endsWith('-musl')) {
              console.log('IMAGE=node:${{ matrix.node }}-alpine')
            } else {
              console.log('IMAGE=node:${{ matrix.node }}-slim')
            }
          " >> $GITHUB_OUTPUT
          echo "PNPM_STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: 安装依赖
        run: pnpm install --force

      - name: 下载构建产物
        uses: actions/download-artifact@v7
        with:
          name: bindings-${{ matrix.target }}
          path: .

      - name: 列出文件
        run: ls -R .
        shell: bash

      # 为 ARM v7 架构设置 QEMU 模拟器（未知）
      - name: 设置 QEMU（ARM v7）
        if: ${{ contains(matrix.target, 'armv7') }}
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      # 启用 QEMU 用户态模拟
      - name: 启用 QEMU 用户态模拟（ARM v7）
        if: ${{ contains(matrix.target, 'armv7') }}
        run: docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: 在 Docker 中运行测试
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ steps.docker.outputs.IMAGE }}
          options: '-v ${{ steps.docker.outputs.PNPM_STORE_PATH }}:${{ steps.docker.outputs.PNPM_STORE_PATH }} -v ${{ github.workspace }}:${{ github.workspace }} -w ${{ github.workspace }} --platform ${{ steps.docker.outputs.PLATFORM }}'
          run: npm run test

  # ============================================
  # Job 6: 发布到 npm
  # ============================================
  publish:
    name: 发布到 npm
    runs-on: ubuntu-latest
    needs:
      - lint
      - cargo-deny
      - test-macOS-windows-binding
      - test-linux-binding
    steps:
      - uses: actions/checkout@v6

      - name: 设置 pnpm
        uses: pnpm/action-setup@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm

      - name: 安装依赖
        run: pnpm install

      - name: 下载所有构建产物
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: 创建 npm 目录
        run: pnpm napi create-npm-dirs

      - name: 移动构建产物
        run: pnpm artifacts

      - name: 列出 npm 目录
        run: ls -R ./npm
        shell: bash

      - name: 发布到 npm
        run: |
          npm config set provenance true
          if git log -1 --pretty=%B | grep "^v\?[0-9]\+\.[0-9]\+\.[0-9]\+$";
          then
            echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> ~/.npmrc
            npm publish --access public
          elif git log -1 --pretty=%B | grep "^v\?[0-9]\+\.[0-9]\+\.[0-9]\+";
          then
            echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> ~/.npmrc
            npm publish --tag next --access public
          else
            echo "不是发布版本，跳过发布"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
